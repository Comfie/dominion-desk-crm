# Messaging System Architecture Diagram

## ğŸ—ï¸ Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND UI LAYER                               â”‚
â”‚                         (React/Next.js Client Components)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  /messages     â”‚  â”‚  /messages/    â”‚  â”‚  /messages/    â”‚                â”‚
â”‚  â”‚  (Inbox)       â”‚  â”‚  automations   â”‚  â”‚  scheduled     â”‚                â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚                â”‚
â”‚  â”‚ â€¢ List view    â”‚  â”‚ â€¢ List rules   â”‚  â”‚ â€¢ Queue view   â”‚                â”‚
â”‚  â”‚ â€¢ Filters      â”‚  â”‚ â€¢ Create form  â”‚  â”‚ â€¢ Status       â”‚                â”‚
â”‚  â”‚ â€¢ Search       â”‚  â”‚ â€¢ Edit form    â”‚  â”‚ â€¢ Cancel       â”‚                â”‚
â”‚  â”‚ â€¢ Compose      â”‚  â”‚ â€¢ Test send    â”‚  â”‚ â€¢ Retry        â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  /messages/    â”‚  â”‚  /messages/    â”‚  â”‚  Components    â”‚                â”‚
â”‚  â”‚  templates     â”‚  â”‚  threads       â”‚  â”‚                â”‚                â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚ â€¢ MessageCard  â”‚                â”‚
â”‚  â”‚ â€¢ Library      â”‚  â”‚ â€¢ Inbox        â”‚  â”‚ â€¢ VarPicker    â”‚                â”‚
â”‚  â”‚ â€¢ Editor       â”‚  â”‚ â€¢ Conversation â”‚  â”‚ â€¢ TemplateForm â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ HTTP/JSON
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              API LAYER (Route Handlers)                      â”‚
â”‚                           Next.js 16 App Router                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Authentication (requireAuth) â†’ Authorization (organizationId) â†’ Audit Log  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ /api/messaging/      â”‚  â”‚ /api/messaging/      â”‚  â”‚ /api/messaging/  â”‚  â”‚
â”‚  â”‚ automations          â”‚  â”‚ scheduled            â”‚  â”‚ threads          â”‚  â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ GET    - List all    â”‚  â”‚ GET    - List queue  â”‚  â”‚ GET  - List      â”‚  â”‚
â”‚  â”‚ POST   - Create new  â”‚  â”‚ GET/id - Get one     â”‚  â”‚ POST - Create    â”‚  â”‚
â”‚  â”‚ GET/id - Get one     â”‚  â”‚ DELETE - Cancel      â”‚  â”‚ PUT  - Update    â”‚  â”‚
â”‚  â”‚ PUT/id - Update      â”‚  â”‚ POST/process - Cron  â”‚  â”‚ DEL  - Delete    â”‚  â”‚
â”‚  â”‚ DELETE - Remove      â”‚  â”‚                      â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ POST/toggle - On/Off â”‚  â”‚ ğŸ” CRON_SECRET Auth  â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ POST/test - Test sendâ”‚  â”‚                      â”‚  â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ /api/messages (LEGACY)                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚ GET  - List messages                                                 â”‚   â”‚
â”‚  â”‚ POST - Create message record                                         â”‚   â”‚
â”‚  â”‚ POST /send - Send email (uses old nodemailer directly)               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚ âš ï¸  NEEDS INTEGRATION: Multi-tenancy fix, use new delivery provider  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Service calls
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SERVICE LAYER (Business Logic)                    â”‚
â”‚                         TypeScript Classes & Functions                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AutomationService   â”‚  â”‚ MessageScheduler    â”‚  â”‚ TemplateEngine    â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚ Service             â”‚  â”‚ Service           â”‚   â”‚
â”‚  â”‚ â€¢ getAll()          â”‚  â”‚                     â”‚  â”‚                   â”‚   â”‚
â”‚  â”‚ â€¢ getById()         â”‚  â”‚ â€¢ scheduleForBookingâ”‚  â”‚ â€¢ render()        â”‚   â”‚
â”‚  â”‚ â€¢ create()          â”‚  â”‚   - Find automationsâ”‚  â”‚ â€¢ extractVars()   â”‚   â”‚
â”‚  â”‚ â€¢ update()          â”‚  â”‚   - Filter by props â”‚  â”‚ â€¢ getNestedValue()â”‚   â”‚
â”‚  â”‚ â€¢ delete()          â”‚  â”‚   - Calc time       â”‚  â”‚                   â”‚   â”‚
â”‚  â”‚ â€¢ toggle()          â”‚  â”‚   - Render template â”‚  â”‚ {{guestName}}     â”‚   â”‚
â”‚  â”‚ â€¢ testAutomation()  â”‚  â”‚   - Create scheduledâ”‚  â”‚ {{property.name}} â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚  â”‚ {{checkInDate}}   â”‚   â”‚
â”‚  â”‚ Business Rules:     â”‚  â”‚ â€¢ processPending()  â”‚  â”‚                   â”‚   â”‚
â”‚  â”‚ â€¢ Validate props    â”‚  â”‚   - Query pending   â”‚  â”‚ Context-aware     â”‚   â”‚
â”‚  â”‚ â€¢ Check ownership   â”‚  â”‚   - Send via providerâ”‚ Variable replace  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   - Update status   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚   - Track analytics â”‚                          â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Repository calls
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         REPOSITORY LAYER (Data Access)                       â”‚
â”‚                          Prisma ORM Query Builders                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Automation         â”‚  â”‚ ScheduledMessage   â”‚  â”‚ Thread               â”‚  â”‚
â”‚  â”‚ Repository         â”‚  â”‚ Repository         â”‚  â”‚ Repository           â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â€¢ findAll()        â”‚  â”‚ â€¢ findAll()        â”‚  â”‚ â€¢ findAll()          â”‚  â”‚
â”‚  â”‚ â€¢ findActive()     â”‚  â”‚ â€¢ findById()       â”‚  â”‚ â€¢ findById()         â”‚  â”‚
â”‚  â”‚ â€¢ findById()       â”‚  â”‚ â€¢ findPending()    â”‚  â”‚ â€¢ create()           â”‚  â”‚
â”‚  â”‚ â€¢ create()         â”‚  â”‚ â€¢ create()         â”‚  â”‚ â€¢ update()           â”‚  â”‚
â”‚  â”‚ â€¢ update()         â”‚  â”‚ â€¢ updateStatus()   â”‚  â”‚ â€¢ delete()           â”‚  â”‚
â”‚  â”‚ â€¢ delete()         â”‚  â”‚ â€¢ cancel()         â”‚  â”‚ â€¢ findByParticipant()â”‚  â”‚
â”‚  â”‚ â€¢ toggleActive()   â”‚  â”‚ â€¢ findByBooking()  â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â€¢ incrementAnalyticsâ”‚ â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ Multi-tenancy:     â”‚  â”‚ Multi-tenancy:     â”‚  â”‚ Multi-tenancy:       â”‚  â”‚
â”‚  â”‚ WHERE userId = ?   â”‚  â”‚ WHERE userId = ?   â”‚  â”‚ WHERE userId = ?     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ CannedResponse Repository                                              â”‚ â”‚
â”‚  â”‚ â€¢ findAll() â€¢ findById() â€¢ create() â€¢ update() â€¢ delete()              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Prisma Client
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATABASE LAYER (PostgreSQL)                        â”‚
â”‚                              Prisma ORM Schema                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MessageAutomation  â”‚  â”‚ ScheduledMessage   â”‚  â”‚ Message (LEGACY)     â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â€¢ id               â”‚  â”‚ â€¢ id               â”‚  â”‚ â€¢ id                 â”‚  â”‚
â”‚  â”‚ â€¢ userId           â”‚  â”‚ â€¢ userId           â”‚  â”‚ â€¢ userId             â”‚  â”‚
â”‚  â”‚ â€¢ name             â”‚  â”‚ â€¢ automationId     â”‚  â”‚ â€¢ bookingId          â”‚  â”‚
â”‚  â”‚ â€¢ triggerType      â”‚  â”‚ â€¢ bookingId        â”‚  â”‚ â€¢ tenantId           â”‚  â”‚
â”‚  â”‚ â€¢ triggerOffset    â”‚  â”‚ â€¢ recipientEmail   â”‚  â”‚ â€¢ subject            â”‚  â”‚
â”‚  â”‚ â€¢ triggerTimeOfDay â”‚  â”‚ â€¢ recipientPhone   â”‚  â”‚ â€¢ message            â”‚  â”‚
â”‚  â”‚ â€¢ messageType      â”‚  â”‚ â€¢ messageType      â”‚  â”‚ â€¢ messageType        â”‚  â”‚
â”‚  â”‚ â€¢ subject          â”‚  â”‚ â€¢ subject          â”‚  â”‚ â€¢ direction          â”‚  â”‚
â”‚  â”‚ â€¢ bodyTemplate     â”‚  â”‚ â€¢ body             â”‚  â”‚ â€¢ recipientEmail     â”‚  â”‚
â”‚  â”‚ â€¢ useAiEnhancement â”‚  â”‚ â€¢ scheduledFor     â”‚  â”‚ â€¢ recipientPhone     â”‚  â”‚
â”‚  â”‚ â€¢ aiTone           â”‚  â”‚ â€¢ status           â”‚  â”‚ â€¢ status             â”‚  â”‚
â”‚  â”‚ â€¢ applyToRentalTypeâ”‚  â”‚ â€¢ sentAt           â”‚  â”‚ â€¢ sentAt             â”‚  â”‚
â”‚  â”‚ â€¢ propertyIds (JSONâ”‚  â”‚ â€¢ errorMessage     â”‚  â”‚ â€¢ deliveredAt        â”‚  â”‚
â”‚  â”‚ â€¢ isActive         â”‚  â”‚                    â”‚  â”‚ â€¢ readAt             â”‚  â”‚
â”‚  â”‚ â€¢ totalSent        â”‚  â”‚ Relations:         â”‚  â”‚ â€¢ threadId           â”‚  â”‚
â”‚  â”‚ â€¢ totalOpened      â”‚  â”‚ â†’ User             â”‚  â”‚ â€¢ replyTo            â”‚  â”‚
â”‚  â”‚ â€¢ totalClicked     â”‚  â”‚ â†’ Automation       â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚ â†’ Booking          â”‚  â”‚ Relations:           â”‚  â”‚
â”‚  â”‚ Relations:         â”‚  â”‚ â†’ Tenant           â”‚  â”‚ â†’ User               â”‚  â”‚
â”‚  â”‚ â†’ User             â”‚  â”‚                    â”‚  â”‚ â†’ Booking            â”‚  â”‚
â”‚  â”‚ â† ScheduledMessage â”‚  â”‚                    â”‚  â”‚ â†’ Tenant             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MessageThread      â”‚  â”‚ CannedResponse     â”‚  â”‚ MessageTemplate      â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚ (LEGACY - MIGRATE)   â”‚  â”‚
â”‚  â”‚ â€¢ id               â”‚  â”‚ â€¢ id               â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â€¢ userId           â”‚  â”‚ â€¢ userId           â”‚  â”‚ â€¢ id                 â”‚  â”‚
â”‚  â”‚ â€¢ bookingId        â”‚  â”‚ â€¢ name             â”‚  â”‚ â€¢ userId             â”‚  â”‚
â”‚  â”‚ â€¢ tenantId         â”‚  â”‚ â€¢ shortcut         â”‚  â”‚ â€¢ name               â”‚  â”‚
â”‚  â”‚ â€¢ propertyId       â”‚  â”‚ â€¢ content          â”‚  â”‚ â€¢ description        â”‚  â”‚
â”‚  â”‚ â€¢ participantName  â”‚  â”‚ â€¢ category         â”‚  â”‚ â€¢ subject            â”‚  â”‚
â”‚  â”‚ â€¢ participantEmail â”‚  â”‚ â€¢ messageType      â”‚  â”‚ â€¢ body               â”‚  â”‚
â”‚  â”‚ â€¢ participantPhone â”‚  â”‚ â€¢ isActive         â”‚  â”‚ â€¢ messageType        â”‚  â”‚
â”‚  â”‚ â€¢ subject          â”‚  â”‚                    â”‚  â”‚ â€¢ variables (JSON)   â”‚  â”‚
â”‚  â”‚ â€¢ lastMessageAt    â”‚  â”‚ Relations:         â”‚  â”‚ â€¢ category           â”‚  â”‚
â”‚  â”‚ â€¢ unreadCount      â”‚  â”‚ â†’ User             â”‚  â”‚ â€¢ isActive           â”‚  â”‚
â”‚  â”‚ â€¢ status           â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚ Relations:           â”‚  â”‚
â”‚  â”‚ Relations:         â”‚  â”‚                    â”‚  â”‚ â†’ User               â”‚  â”‚
â”‚  â”‚ â†’ User             â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â†’ Booking          â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â†’ Tenant           â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â†’ Property         â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚ â† Messages         â”‚  â”‚                    â”‚  â”‚                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  Indexes:                                                                    â”‚
â”‚  â€¢ (userId, isActive) on MessageAutomation                                   â”‚
â”‚  â€¢ (triggerType) on MessageAutomation                                        â”‚
â”‚  â€¢ (scheduledFor, status) on ScheduledMessage                                â”‚
â”‚  â€¢ (userId, unreadCount) on MessageThread                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DELIVERY LAYER (External Services)                   â”‚
â”‚                         Multi-Channel Abstraction                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        DeliveryProviderService                               â”‚
â”‚                                                                              â”‚
â”‚                    send(message: DeliveryMessage)                            â”‚
â”‚                                 â”‚                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚            â”‚            â”‚                               â”‚
â”‚                    â†“            â†“            â†“                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚  EMAIL  â”‚  â”‚   SMS   â”‚  â”‚WhatsApp â”‚                          â”‚
â”‚              â”‚         â”‚  â”‚         â”‚  â”‚         â”‚                          â”‚
â”‚              â”‚ âœ… Impl â”‚  â”‚ â³ Stub â”‚  â”‚ â³ Stub â”‚                          â”‚
â”‚              â”‚         â”‚  â”‚         â”‚  â”‚         â”‚                          â”‚
â”‚              â”‚ Uses:   â”‚  â”‚ Ready:  â”‚  â”‚ Ready:  â”‚                          â”‚
â”‚              â”‚ lib/    â”‚  â”‚ Twilio  â”‚  â”‚ WhatsAppâ”‚                          â”‚
â”‚              â”‚ email.tsâ”‚  â”‚ API     â”‚  â”‚ Businessâ”‚                          â”‚
â”‚              â”‚         â”‚  â”‚         â”‚  â”‚ API     â”‚                          â”‚
â”‚              â”‚ SMTP:   â”‚  â”‚         â”‚  â”‚         â”‚                          â”‚
â”‚              â”‚ nodemailerâ”‚         â”‚  â”‚         â”‚                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚
                                      â†“
                            ğŸ“§ ğŸ“± ğŸ’¬ Message Delivered!
```

---

## ğŸ”„ Data Flow: Automation Message Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TRIGGER EVENT (e.g., Booking Created)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Booking API calls messageSchedulerService.scheduleForBooking()      â”‚
â”‚     â€¢ bookingId: "booking_123"                                          â”‚
â”‚     â€¢ userId: "org_456"                                                 â”‚
â”‚     â€¢ trigger: AutomationTrigger.BOOKING_CREATED                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Scheduler fetches booking with property details from DB             â”‚
â”‚     SELECT * FROM Booking WHERE id = 'booking_123' INCLUDE property     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Scheduler finds active automations for this trigger                 â”‚
â”‚     SELECT * FROM MessageAutomation WHERE                               â”‚
â”‚       userId = 'org_456' AND                                            â”‚
â”‚       isActive = true AND                                               â”‚
â”‚       triggerType = 'BOOKING_CREATED'                                   â”‚
â”‚     Result: 2 automations found                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. For each automation, check filters:                                 â”‚
â”‚     â€¢ propertyIds: Does booking.propertyId match? âœ…                    â”‚
â”‚     â€¢ applyToRentalType: Does booking.bookingType match? âœ…             â”‚
â”‚     â†’ Automation #1 matches, continue                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Calculate scheduled time:                                           â”‚
â”‚     â€¢ Base: NOW (booking created)                                       â”‚
â”‚     â€¢ Offset: +0 hours (send immediately)                               â”‚
â”‚     â€¢ TimeOfDay: null                                                   â”‚
â”‚     â†’ scheduledFor = 2025-12-02 22:00:00                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Build template context from booking data:                           â”‚
â”‚     {                                                                   â”‚
â”‚       guestName: "John Doe",                                            â”‚
â”‚       guestEmail: "john@example.com",                                   â”‚
â”‚       propertyName: "Ocean View Villa",                                 â”‚
â”‚       propertyAddress: "123 Beach Rd",                                  â”‚
â”‚       checkInDate: "12/15/2025",                                        â”‚
â”‚       checkInTime: "15:00",                                             â”‚
â”‚       totalAmount: "$1,200",                                            â”‚
â”‚       ...                                                               â”‚
â”‚     }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Render template using TemplateEngineService:                        â”‚
â”‚     Template: "Hi {{guestName}}, your booking at {{propertyName}}..."   â”‚
â”‚     Context: { guestName: "John Doe", propertyName: "Ocean View..." }  â”‚
â”‚     Result: "Hi John Doe, your booking at Ocean View Villa..."         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. Create ScheduledMessage record:                                     â”‚
â”‚     INSERT INTO ScheduledMessage (                                      â”‚
â”‚       userId: 'org_456',                                                â”‚
â”‚       automationId: 'auto_789',                                         â”‚
â”‚       bookingId: 'booking_123',                                         â”‚
â”‚       recipientEmail: 'john@example.com',                               â”‚
â”‚       messageType: 'EMAIL',                                             â”‚
â”‚       subject: 'Booking Confirmation',                                  â”‚
â”‚       body: 'Hi John Doe, your booking...',                             â”‚
â”‚       scheduledFor: '2025-12-02 22:00:00',                              â”‚
â”‚       status: 'PENDING'                                                 â”‚
â”‚     )                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                             â° Wait for scheduled time...
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. Cron job runs (every 10 minutes):                                   â”‚
â”‚     POST /api/messaging/scheduled/process                               â”‚
â”‚     Authorization: Bearer {CRON_SECRET}                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. processPending() queries messages to send:                         â”‚
â”‚      SELECT * FROM ScheduledMessage WHERE                               â”‚
â”‚        scheduledFor <= NOW() AND                                        â”‚
â”‚        status = 'PENDING'                                               â”‚
â”‚      Result: 15 messages (including our booking confirmation)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  11. For each pending message:                                          â”‚
â”‚      UPDATE ScheduledMessage SET status = 'SENDING' WHERE id = ...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  12. Send via DeliveryProviderService:                                  â”‚
â”‚      deliveryProviderService.send({                                     â”‚
â”‚        type: 'EMAIL',                                                   â”‚
â”‚        recipient: 'john@example.com',                                   â”‚
â”‚        subject: 'Booking Confirmation',                                 â”‚
â”‚        body: 'Hi John Doe...'                                           â”‚
â”‚      })                                                                 â”‚
â”‚      â†’ Calls lib/email.ts â†’ nodemailer â†’ SMTP â†’ âœ‰ï¸ Sent!               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  13. Update message status to SENT:                                     â”‚
â”‚      UPDATE ScheduledMessage SET                                        â”‚
â”‚        status = 'SENT',                                                 â”‚
â”‚        sentAt = NOW()                                                   â”‚
â”‚      WHERE id = ...                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  14. Increment automation analytics:                                    â”‚
â”‚      UPDATE MessageAutomation SET totalSent = totalSent + 1             â”‚
â”‚      WHERE id = 'auto_789'                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  15. Return cron job results:                                           â”‚
â”‚      {                                                                  â”‚
â”‚        success: true,                                                   â”‚
â”‚        processed: 15,                                                   â”‚
â”‚        succeeded: 14,                                                   â”‚
â”‚        failed: 1                                                        â”‚
â”‚      }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â†“
                        âœ… Guest receives confirmation email!
```

---

## ğŸ”€ Integration Points with Existing Systems

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BOOKING SYSTEM                             â”‚
â”‚                                                                 â”‚
â”‚  app/api/bookings/route.ts (POST)                              â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ 1. Create booking in DB                                    â”‚
â”‚  â”œâ”€ 2. [NEW] Import messageSchedulerService                    â”‚
â”‚  â””â”€ 3. [NEW] Call scheduleForBooking(                          â”‚
â”‚         booking.id,                                            â”‚
â”‚         session.user.organizationId,                           â”‚
â”‚         AutomationTrigger.BOOKING_CREATED                      â”‚
â”‚      )                                                         â”‚
â”‚                                                                 â”‚
â”‚  app/api/bookings/[id]/route.ts (PUT - confirm)                â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ [NEW] Call scheduleForBooking(..., BOOKING_CONFIRMED)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PAYMENT SYSTEM                             â”‚
â”‚                                                                 â”‚
â”‚  app/api/payments/route.ts (POST)                              â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ [NEW] Call scheduleForBooking(..., PAYMENT_RECEIVED)       â”‚
â”‚                                                                 â”‚
â”‚  [Future] Payment reminder cron job                            â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ Check overdue payments                                     â”‚
â”‚     â””â”€ Call scheduleForBooking(..., PAYMENT_OVERDUE)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MAINTENANCE SYSTEM                            â”‚
â”‚                                                                 â”‚
â”‚  app/api/maintenance/route.ts (POST)                           â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ [NEW] Call scheduleForBooking(..., MAINTENANCE_SCHEDULED)  â”‚
â”‚                                                                 â”‚
â”‚  app/api/maintenance/[id]/route.ts (PUT - complete)            â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ [NEW] Call scheduleForBooking(..., MAINTENANCE_COMPLETED)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LEGACY MESSAGE SYSTEM                       â”‚
â”‚                                                                 â”‚
â”‚  [CRITICAL FIX] app/api/messages/route.ts                      â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ Change: userId â†’ session.user.organizationId               â”‚
â”‚  â””â”€ Impact: Multi-tenancy compliance                           â”‚
â”‚                                                                 â”‚
â”‚  [INTEGRATION] app/api/messages/send/route.ts                  â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ Replace: lib/email.ts direct call                          â”‚
â”‚  â””â”€ With: deliveryProviderService.send()                       â”‚
â”‚                                                                 â”‚
â”‚  [NEW] After automation sends:                                 â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ Create Message record for unified inbox                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Frontend UI Structure (Proposed)

```
app/(dashboard)/messages/
â”‚
â”œâ”€â”€ layout.tsx (Navigation tabs)
â”‚   â”‚
â”‚   â”œâ”€ Tab: Inbox
â”‚   â”œâ”€ Tab: Scheduled
â”‚   â”œâ”€ Tab: Automations
â”‚   â”œâ”€ Tab: Templates
â”‚   â””â”€ Tab: Threads
â”‚
â”œâ”€â”€ page.tsx (Inbox - EXISTING)
â”‚   â”œâ”€ Summary cards (total, unread, sent today, failed)
â”‚   â”œâ”€ Filters (direction, type, status)
â”‚   â”œâ”€ Message list (MessageCard components)
â”‚   â””â”€ Pagination
â”‚
â”œâ”€â”€ new/page.tsx (Compose - EXISTING)
â”‚   â”œâ”€ Recipient selection (booking/tenant)
â”‚   â”œâ”€ Message type selector
â”‚   â”œâ”€ Template selector
â”‚   â”œâ”€ Subject/body fields
â”‚   â””â”€ Send button
â”‚
â”œâ”€â”€ automations/
â”‚   â”‚
â”‚   â”œâ”€â”€ page.tsx (List automations - NEW)
â”‚   â”‚   â”œâ”€ Summary cards (active, total sent, success rate)
â”‚   â”‚   â”œâ”€ Filter by trigger type
â”‚   â”‚   â”œâ”€ Automation cards with:
â”‚   â”‚   â”‚   â”œâ”€ Name, description
â”‚   â”‚   â”‚   â”œâ”€ Trigger badge
â”‚   â”‚   â”‚   â”œâ”€ Active toggle
â”‚   â”‚   â”‚   â”œâ”€ Analytics (sent, opened, clicked)
â”‚   â”‚   â”‚   â””â”€ Actions (edit, test, delete)
â”‚   â”‚   â””â”€ Create automation button
â”‚   â”‚
â”‚   â”œâ”€â”€ new/page.tsx (Create automation - NEW)
â”‚   â”‚   â”œâ”€ Step 1: Trigger configuration
â”‚   â”‚   â”‚   â”œâ”€ Trigger type dropdown
â”‚   â”‚   â”‚   â”œâ”€ Offset slider (-48 to +48 hours)
â”‚   â”‚   â”‚   â””â”€ Time of day picker
â”‚   â”‚   â”œâ”€ Step 2: Message template
â”‚   â”‚   â”‚   â”œâ”€ Message type (Email/SMS/WhatsApp)
â”‚   â”‚   â”‚   â”œâ”€ Subject field
â”‚   â”‚   â”‚   â”œâ”€ Body textarea with variable picker
â”‚   â”‚   â”‚   â””â”€ Preview panel
â”‚   â”‚   â”œâ”€ Step 3: Filters
â”‚   â”‚   â”‚   â”œâ”€ Property multi-select
â”‚   â”‚   â”‚   â””â”€ Rental type selector
â”‚   â”‚   â”œâ”€ Step 4: AI enhancement (optional)
â”‚   â”‚   â”‚   â”œâ”€ Enable AI toggle
â”‚   â”‚   â”‚   â””â”€ Tone selector
â”‚   â”‚   â””â”€ Create button
â”‚   â”‚
â”‚   â””â”€â”€ [id]/
â”‚       â”œâ”€â”€ page.tsx (View automation - NEW)
â”‚       â”‚   â”œâ”€ Automation details
â”‚       â”‚   â”œâ”€ Analytics chart
â”‚       â”‚   â”œâ”€ Recent sent messages
â”‚       â”‚   â””â”€ Edit/Delete/Test buttons
â”‚       â”‚
â”‚       â””â”€â”€ edit/page.tsx (Edit automation - NEW)
â”‚           â””â”€ Same as new/page.tsx but pre-filled
â”‚
â”œâ”€â”€ scheduled/
â”‚   â”‚
â”‚   â””â”€â”€ page.tsx (Scheduled queue - NEW)
â”‚       â”œâ”€ Summary cards (pending, scheduled today, failed)
â”‚       â”œâ”€ Filter by status/type
â”‚       â”œâ”€ Scheduled message cards with:
â”‚       â”‚   â”œâ”€ Recipient info
â”‚       â”‚   â”œâ”€ Scheduled time (countdown)
â”‚       â”‚   â”œâ”€ Status badge
â”‚       â”‚   â”œâ”€ Automation name
â”‚       â”‚   â””â”€ Cancel button (if pending)
â”‚       â””â”€ Pagination
â”‚
â”œâ”€â”€ templates/
â”‚   â”‚
â”‚   â”œâ”€â”€ page.tsx (Template library - EXISTING, ENHANCE)
â”‚   â”‚   â”œâ”€ Predefined templates (NEW)
â”‚   â”‚   â”œâ”€ Custom templates
â”‚   â”‚   â”œâ”€ Category filter
â”‚   â”‚   â””â”€ Create template button
â”‚   â”‚
â”‚   â””â”€â”€ new/page.tsx (Create template - EXISTING, ENHANCE)
â”‚       â”œâ”€ Template name
â”‚       â”œâ”€ Category
â”‚       â”œâ”€ Subject/body with {{variable}} support (NEW)
â”‚       â”œâ”€ Variable picker component (NEW)
â”‚       â””â”€ Preview with sample data (NEW)
â”‚
â””â”€â”€ threads/
    â”‚
    â”œâ”€â”€ page.tsx (Conversation inbox - NEW)
    â”‚   â”œâ”€ Thread list with unread count
    â”‚   â”œâ”€ Participant info
    â”‚   â”œâ”€ Last message preview
    â”‚   â””â”€ Click to view conversation
    â”‚
    â””â”€â”€ [id]/page.tsx (Conversation view - NEW)
        â”œâ”€ Participant details
        â”œâ”€ Message timeline
        â”œâ”€ Reply form with canned responses
        â””â”€ Context info (booking, property)
```

---

## ğŸ§© Component Architecture

```
components/messages/
â”‚
â”œâ”€â”€ message-card.tsx (EXISTING)
â”‚   â”œâ”€ Display: subject, preview, recipient, status
â”‚   â”œâ”€ Icons: direction, message type
â”‚   â””â”€ [ENHANCE] Show automation badge if automated
â”‚
â”œâ”€â”€ automation-card.tsx (NEW)
â”‚   â”œâ”€ Automation name, description
â”‚   â”œâ”€ Trigger badge with icon
â”‚   â”œâ”€ Active toggle switch
â”‚   â”œâ”€ Analytics (totalSent, success rate)
â”‚   â””â”€ Actions dropdown (edit, test, delete)
â”‚
â”œâ”€â”€ scheduled-message-card.tsx (NEW)
â”‚   â”œâ”€ Recipient info
â”‚   â”œâ”€ Countdown timer to send time
â”‚   â”œâ”€ Status badge (pending, sending, sent, failed)
â”‚   â”œâ”€ Preview of message content
â”‚   â””â”€ Cancel button (if pending)
â”‚
â”œâ”€â”€ template-editor.tsx (NEW)
â”‚   â”œâ”€ Subject input
â”‚   â”œâ”€ Body textarea with syntax highlighting
â”‚   â”œâ”€ Variable picker sidebar
â”‚   â”œâ”€ Preview panel with live rendering
â”‚   â””â”€ Save/Cancel buttons
â”‚
â”œâ”€â”€ variable-picker.tsx (NEW)
â”‚   â”œâ”€ Search variables
â”‚   â”œâ”€ Category tabs (guest, property, booking)
â”‚   â”œâ”€ Click to insert {{variable}}
â”‚   â””â”€ Help text for each variable
â”‚
â”œâ”€â”€ automation-form-wizard.tsx (NEW)
â”‚   â”œâ”€ Multi-step form with progress indicator
â”‚   â”œâ”€ Step 1: Trigger config component
â”‚   â”œâ”€ Step 2: Template editor component
â”‚   â”œâ”€ Step 3: Filters component
â”‚   â”œâ”€ Step 4: AI config component
â”‚   â””â”€ Navigation (Back, Next, Create)
â”‚
â”œâ”€â”€ analytics-chart.tsx (NEW)
â”‚   â”œâ”€ Line chart: messages sent over time
â”‚   â”œâ”€ Bar chart: success rate by trigger
â”‚   â””â”€ Stats: open rate, click rate
â”‚
â””â”€â”€ thread-view.tsx (NEW)
    â”œâ”€ Message timeline (chat-like UI)
    â”œâ”€ Inbound/outbound differentiation
    â”œâ”€ Timestamp display
    â””â”€ Reply form at bottom
```

---

**Diagram Version**: 1.0
**Last Updated**: December 2, 2025
**Status**: System architecture as implemented
**Next Update**: After frontend implementation
